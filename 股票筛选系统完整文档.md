# 股票筛选系统完整文档

> 本文档整合了股票筛选系统的所有功能说明文档
> 
> 最后更新时间: 2025-10-24

---

## 📑 目录

1. [A股股票列表更新工具](#a股股票列表更新工具)
2. [ADX选股功能说明](#adx选股功能说明)
3. [当前涨幅和前高当前涨幅过滤功能](#当前涨幅和前高当前涨幅过滤功能)

---

# A股股票列表更新工具

## 📋 概述

使用Tushare的`bak_basic`接口获取A股所有股票的完整数据，包括基础信息和财务指标。

**接口文档**: [https://tushare.pro/document/2?doc_id=262](https://tushare.pro/document/2?doc_id=262)

**版本**: 2.0  
**日期**: 2025-10-22  
**数据源**: Tushare Pro `bak_basic`接口

## ✨ 主要特性

### 1. 完整的股票数据

包含以下字段：

**基础信息**:
- `ts_code`: TS股票代码（如：000001.SZ）
- `symbol`: 6位股票代码（如：000001）
- `name`: 股票名称
- `area`: 地域
- `industry`: 行业
- `list_date`: 上市日期

**市场估值**:
- `pe`: 市盈率（动态）
- `pb`: 市净率

**股本结构**:
- `float_share`: 流通股本（亿）
- `total_share`: 总股本（亿）

**资产信息**:
- `total_assets`: 总资产（亿）
- `liquid_assets`: 流动资产（亿）
- `fixed_assets`: 固定资产（亿）

**财务指标**:
- `reserved`: 公积金
- `reserved_pershare`: 每股公积金
- `eps`: 每股收益
- `bvps`: 每股净资产
- `undp`: 未分配利润
- `per_undp`: 每股未分配利润

**经营指标**:
- `rev_yoy`: 收入同比（%）
- `profit_yoy`: 利润同比（%）
- `gpr`: 毛利率（%）
- `npr`: 净利润率（%）

**其他**:
- `holder_num`: 股东人数

### 2. 自动化功能

- ✅ 自动加载Tushare token
- ✅ 自动备份旧文件
- ✅ 自动获取最新交易日数据
- ✅ 完整的日志记录

## 🚀 使用方法

### 基本使用

```bash
# 更新到最新交易日数据
python update_stocklist.py

# 不备份旧文件
python update_stocklist.py --no-backup

# 指定特定日期
python update_stocklist.py --date 20241022

# 指定输出文件
python update_stocklist.py -o mylist.csv

# 查看帮助
python update_stocklist.py --help
```

### 命令行参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-o, --output` | 输出文件路径 | `stocklist.csv` |
| `--no-backup` | 不备份旧文件 | 默认备份 |
| `--date` | 指定交易日期（YYYYMMDD） | 今天 |
| `-h, --help` | 显示帮助信息 | - |

## 📊 输出示例

### CSV文件格式

```csv
ts_code,symbol,name,area,industry,pe,float_share,total_share,total_assets,liquid_assets,fixed_assets,reserved,reserved_pershare,eps,bvps,pb,list_date,undp,per_undp,rev_yoy,profit_yoy,gpr,npr,holder_num
000001.SZ,000001,平安银行,深圳,银行,4.49,194.06,194.06,58749.61,0.0,81.63,807.02,4.16,1.18,22.68,0.51,19910403,2592.07,13.36,-10.04,-3.9,43.38,35.84,443583
```

## 🔧 配置说明

### Tushare Token配置

**配置文件**: `.tushare_token`

**内容**: 您的Tushare token（已配置）

**获取方式**:
1. 注册账号：[https://tushare.pro/](https://tushare.pro/)
2. 在"个人中心"获取token
3. 保存到`.tushare_token`文件

**权限要求**:
- 需要5000积分才能使用`bak_basic`接口
- 单次最多返回7000条数据
- 可以按日期循环获取历史数据

## 💡 使用场景

### 1. 日常更新（推荐）

```bash
# 每天收盘后更新
python update_stocklist.py
```

**频率**: 每个交易日一次  
**时间**: 收盘后（15:00之后）

### 2. 获取历史数据

```bash
# 获取特定日期的数据
python update_stocklist.py --date 20241020
```

**用途**: 回溯测试、历史分析

### 3. 定时任务

```bash
# 添加到crontab，每个交易日下午4点运行
0 16 * * 1-5 cd /Users/xucang/Desktop/stockIdea && python update_stocklist.py
```

**优点**: 自动化更新，无需手动操作

## 📊 数据质量

### 完整性

| 指标 | 覆盖率 |
|------|--------|
| 基础信息 | 100% |
| 行业分类 | 100% |
| 地区信息 | 100% |
| 市盈率 | 100% |
| 财务数据 | 100% |

### 数据特点

✅ **优点**:
- 数据来源权威（Tushare Pro）
- 包含完整的财务指标
- 实时更新（每个交易日）
- 数据质量高

⚠️ **注意**:
- 需要Tushare积分（5000）
- 只包含上市公司数据
- PE为0表示亏损或数据异常

## ⚠️ 注意事项

### 1. Tushare积分要求

- `bak_basic`接口需要**5000积分**
- 免费用户可能无法使用
- 需要在Tushare平台积累积分

### 2. 数据更新时间

- 数据在每个交易日收盘后更新
- 建议在下午4点后运行
- 非交易日会自动尝试前一天的数据

### 3. 数据理解

**市盈率（PE）为0的情况**:
- 公司亏损（负收益）
- 停牌股票
- 数据异常

**资产数据单位**: 亿元

**百分比数据**: 直接显示数值（如：10.5表示10.5%）

## 🎯 最佳实践

### 1. 定期更新

```bash
# 每个交易日自动更新
0 16 * * 1-5 cd /path/to/stockIdea && python update_stocklist.py
```

### 2. 数据验证

更新后检查数据：
```bash
# 查看统计
tail -20 update_stocklist.log

# 抽查数据
head -10 stocklist.csv
```

### 3. 备份管理

```bash
# 定期清理旧备份（保留最近5个）
ls -t stocklist.csv.backup_* | tail -n +6 | xargs rm
```

### 4. 数据分析

```python
import pandas as pd

# 读取数据
df = pd.read_csv('stocklist.csv')

# 基础统计
print(df.describe())

# 行业分布
print(df['industry'].value_counts().head(10))

# 市盈率分析
print(df[df['pe'] > 0]['pe'].describe())
```

---

# ADX选股功能说明

## 功能概述

ADX选股系统是基于DMI（Directional Movement Index）指标的趋势跟踪选股工具。系统包含两个核心选股器：**ADX Selector**（趋势确认）和 **PDI Selector**（多头力量），通过检测特定的上穿信号来识别潜在的趋势启动机会。

### 核心特点
- ✅ **交易日计数**: 所有日期参数（lookback_days、pre_high_days等）均按**交易日**计数，经过严格测试验证
- 🎯 **多周期支持**: 支持39日、105日、243日三个不同周期的DMI指标
- 🔄 **两种策略**: ADX上穿MDI（趋势确认）和PDI上穿MDI（多头启动）
- 📊 **丰富过滤**: 支持涨跌幅、前高价格、历史低点等多维度过滤

## DMI指标说明

### 指标组成
DMI（方向动量指标）包含三条线：
- **PDI** (Positive Directional Indicator): 正向方向线，衡量多头力量
- **MDI** (Minus Directional Indicator): 负向方向线，衡量空头力量
- **ADX** (Average Directional Index): 平均方向指数，衡量趋势强度

### 计算周期
系统预设三个DMI周期：
- **39日**: 短期趋势，灵敏度高
- **105日**: 中期趋势，平衡型
- **243日**: 长期趋势，稳定性强

## 两种选股策略

### 1. ADX Selector（趋势确认策略）

#### 信号定义
在最近 **lookback_days** 个交易日内，寻找 **ADX 上穿 MDI** 的信号：
- **前一交易日**: ADX < MDI
- **当前交易日**: ADX > MDI **且** PDI > MDI

#### 技术含义
- ADX上穿MDI表示趋势强度开始增强
- 同时要求PDI > MDI，确保是多头趋势
- 适合捕捉趋势确认后的跟随机会

#### 配置示例
```json
{
  "class": "ADXSelector",
  "alias": "ADX105",
  "activate": true,
  "params": {
    "dmi_period": 105,
    "lookback_days": 30
  }
}
```

#### 使用场景
- ✅ 趋势跟随：在趋势确认后介入
- ✅ 中长线布局：适合持仓时间较长的投资者
- ✅ 强势股筛选：ADX值越高表示趋势越强

### 2. PDI Selector（多头启动策略）

#### 信号定义
在最近 **lookback_days** 个交易日内，寻找 **PDI 上穿 MDI** 的信号：
- **前一交易日**: PDI < MDI
- **当前交易日**: PDI > MDI

#### 技术含义
- PDI上穿MDI表示多头力量超越空头力量
- 趋势可能从下跌或震荡转为上涨
- 适合捕捉趋势启动的早期机会

#### 配置示例
```json
{
  "class": "PDISelector",
  "alias": "PDI39",
  "activate": true,
  "params": {
    "dmi_period": 39,
    "lookback_days": 30
  }
}
```

#### 使用场景
- ✅ 趋势启动：在多头力量刚刚占优时介入
- ✅ 短线操作：适合灵活进出的投资者
- ✅ 底部反转：捕捉空头转多头的转折点

## 配置参数详解

### configs.json 结构

```json
{
  "selectors": [
    {
      "class": "ADXSelector",      // 选择器类型
      "alias": "ADX105",            // 别名（用于文件命名）
      "activate": true,             // 是否启用
      "params": {
        "dmi_period": 105,          // DMI计算周期（交易日）
        "lookback_days": 30         // 回看天数（交易日）
      }
    }
  ],
  "ADXfilteringconfig": {
    "active": true,                 // 是否启用过滤
    "minRange": "0%",               // 最小涨幅/最大跌幅
    "maxRange": "25%",              // 最大涨幅限制
    "lookback_days": 3,             // 上穿前后天数（交易日）
    "maxRangeUp": "none",           // 期间最大涨幅要求
    "preHighDays": 60,              // 前高天数（交易日）
    "preHighMinRange": "-2%",       // 前高最小涨幅
    "preHighMaxRange": "15%",       // 前高最大涨幅
    "lookback_months": 120,         // 历史低点回看月数
    "HisLowPointRange": "none"      // 历史低点涨幅区间
  },
  "PDIfilteringconfig": {
    // 同ADXfilteringconfig结构
  }
}
```

### 核心参数说明

#### 1. 选股参数
| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `dmi_period` | int | DMI指标周期（交易日） | 39, 105, 243 |
| `lookback_days` | int | 回看天数（交易日），从最后一个交易日往前数 | 30 |

#### 2. 过滤参数

**基础涨跌幅过滤**
| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `minRange` | string | 最小涨幅/最大跌幅，负值表示允许的跌幅 | "0%", "-5%" |
| `maxRange` | string | 最大涨幅限制 | "25%", "none" |

**上穿期间涨幅**
| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `lookback_days` | int | 上穿前后查看的交易日数 | 3 |
| `maxRangeUp` | string | 期间最大涨幅要求 | "5%", "none" |

**前高价格过滤**
| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `preHighDays` | int | 前高天数（交易日） | 60 |
| `preHighMinRange` | string | 前高最小涨幅，可为负 | "-2%" |
| `preHighMaxRange` | string | 前高最大涨幅 | "15%" |

**历史低点过滤**
| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `lookback_months` | int | 回看月数 | 120 |
| `HisLowPointRange` | string | 涨幅区间 | "16-600%", "none" |

## 使用流程

### 1. 数据准备
确保 `data/` 目录下有K线数据文件（CSV格式）：
```
data/
  ├── 000001.csv
  ├── 600000.csv
  └── ...
```

### 2. 选股执行

#### 基本用法
```bash
# 使用当前日期选股
python select_stock.py

# 指定日期选股
python select_stock.py --date 2025-10-21
```

#### 输出结果
选股结果保存在 `{date}-res/` 目录：
```
20251021-res/
  ├── ADX39_2025-10-21.csv
  ├── ADX105_2025-10-21.csv
  ├── ADX243_2025-10-21.csv
  ├── PDI39_2025-10-21.csv
  ├── PDI105_2025-10-21.csv
  └── PDI243_2025-10-21.csv
```

### 3. 结果过滤

#### 基本用法
```bash
# 使用当前日期过滤
python adx_filter.py

# 指定日期过滤
python adx_filter.py --date 2025-10-21
```

#### 输出结果
过滤结果保存在 `{date}-resByFilter/` 目录，包含额外字段：
- `历史低点涨幅(120月)`: 当前价相对历史低点的涨幅
- `枢轴点价格`: 上穿日的基准价格
- `当前涨幅`: 枢轴点到当前的涨幅
- `最小涨幅`: 枢轴点之后的最小涨幅（可能为负）
- `最大涨幅`: 枢轴点之后的最大涨幅
- `上穿期间最大涨幅`: 上穿前后N天的最大涨幅
- `前高价格`: 上穿前N天的最高价
- `前高当前涨幅`: 前高价到当前的涨幅
- `前高最小涨幅`: 前高价到后续最低价的涨幅
- `前高最大涨幅`: 前高价到后续最高价的涨幅

## 实战案例

### 案例1：保守型配置
适合稳健投资者，严格控制风险

```json
{
  "selectors": [
    {
      "class": "ADXSelector",
      "alias": "ADX243",
      "params": {
        "dmi_period": 243,
        "lookback_days": 30
      }
    }
  ],
  "ADXfilteringconfig": {
    "active": true,
    "minRange": "0%",          // 不允许跌破枢轴点
    "maxRange": "15%",         // 涨幅不超过15%
    "maxRangeUp": "5%",        // 上穿期间至少涨5%
    "preHighDays": 60,
    "preHighMinRange": "0%",   // 不允许跌破前高
    "preHighMaxRange": "10%"   // 前高之后涨幅不超过10%
  }
}
```

### 案例2：激进型配置
适合短线投资者，追求高收益

```json
{
  "selectors": [
    {
      "class": "PDISelector",
      "alias": "PDI39",
      "params": {
        "dmi_period": 39,
        "lookback_days": 10
      }
    }
  ],
  "PDIfilteringconfig": {
    "active": true,
    "minRange": "-5%",         // 允许5%回调
    "maxRange": "50%",         // 涨幅可达50%
    "maxRangeUp": "none",      // 不限制上穿期间涨幅
    "preHighMinRange": "-10%", // 允许跌破前高10%
    "preHighMaxRange": "none"  // 不限制前高之后涨幅
  }
}
```

## 常见问题

### Q1: lookback_days 是交易日还是自然日？
**A**: 交易日。所有天数参数都按交易日计数，已通过测试验证。

### Q2: 为什么有的股票没有被选出？
**A**: 可能的原因：
1. 在 `lookback_days` 期间内没有发生上穿信号
2. DMI周期太长，历史数据不足
3. 被后续的过滤条件筛掉

### Q3: 如何调整选股灵敏度？
**A**: 
- 增加灵敏度：减小 `dmi_period`，增大 `lookback_days`
- 降低灵敏度：增大 `dmi_period`，减小 `lookback_days`

### Q4: 多周期如何选择？
**A**:
- **39日**: 适合短线，信号多但噪音也多
- **105日**: 适合中线，信号质量较高
- **243日**: 适合长线，信号少但可靠性高

## 性能优化建议

### 1. 并发处理
```bash
# 根据CPU核心数调整workers
python select_stock.py --workers 8
python adx_filter.py --workers 12
```

### 2. 数据管理
- 定期清理旧的结果目录
- K线数据文件不要过大（建议<10MB）
- 使用SSD存储数据文件

### 3. 配置优化
- 只启用需要的selector（设置 `activate: false`）
- 合理设置 `lookback_days`（不要过大）
- 过滤条件不要设置得过于严格（否则可能选不出股票）

## 注意事项

1. **数据质量**: 确保K线数据完整、准确，缺失数据会影响DMI计算
2. **回看天数**: `lookback_days` 设置过小可能漏掉信号，过大会增加计算量
3. **参数调优**: 不同市场环境需要不同参数，建议回测验证
4. **过滤逻辑**: 理解每个过滤条件的含义，避免设置矛盾的条件
5. **交易日**: 系统自动处理交易日，不需要手动排除周末节假日

---

# 当前涨幅和前高当前涨幅过滤功能

## 更新时间
2024-10-24

## 功能概述
在ADX和PDI过滤配置中新增了两个过滤条件，用于基于当前涨幅和前高当前涨幅来筛选股票。

## 新增配置项

### 1. 当前涨幅过滤 (`currentRangeFilter`)
- **说明**: 过滤枢轴点价格到最后一日收盘价的涨幅范围
- **格式**: `"起始%-结束%"` 或 `"none"`
- **示例**: 
  - `"-1%-10%"`: 选出跌幅小于-1%且涨幅不超过10%的股票
  - `"0%-5%"`: 选出涨幅在0%到5%之间的股票
  - `"-5%-0%"`: 选出跌幅在-5%到0%之间的股票
  - `"none"`: 不进行过滤（默认值）

### 2. 前高当前涨幅过滤 (`preHighCurrentRangeFilter`)
- **说明**: 过滤前高价格到最后一日收盘价的涨幅范围
- **格式**: `"起始%-结束%"` 或 `"none"`
- **示例**: 同上

## 配置文件位置
`configs.json`

## 配置示例

### ADX过滤配置
```json
"ADXfilteringconfig": {
  "active": true,
  "minRange": "0%",
  "maxRange": "25%",
  "lookback_days": 3,
  "maxRangeUp": "none",
  "preHighDays": 60,
  "preHighMinRange": "0%",
  "preHighMaxRange": "15%",
  "lookback_months": 120,
  "HisLowPointRange": "none",
  "currentRangeFilter": "-1%-10%",           // 新增
  "preHighCurrentRangeFilter": "-1%-10%"     // 新增
}
```

### PDI过滤配置
```json
"PDIfilteringconfig": {
  "active": true,
  "minRange": "0%",
  "maxRange": "25%",
  "lookback_days": 3,
  "maxRangeUp": "none",
  "preHighDays": 60,
  "preHighMinRange": "0%",
  "preHighMaxRange": "15%",
  "lookback_months": 120,
  "HisLowPointRange": "none",
  "currentRangeFilter": "-1%-10%",           // 新增
  "preHighCurrentRangeFilter": "-1%-10%"     // 新增
}
```

## 使用场景

### 场景1: 筛选小幅下跌的股票
寻找当前略微下跌但跌幅不大的股票（可能是回调买入机会）：
```json
"currentRangeFilter": "-5%-0%",
"preHighCurrentRangeFilter": "-5%-0%"
```

### 场景2: 筛选温和上涨的股票
寻找当前有一定涨幅但不是暴涨的股票：
```json
"currentRangeFilter": "5%-15%",
"preHighCurrentRangeFilter": "5%-15%"
```

### 场景3: 筛选横盘股票
寻找当前在小范围内波动的股票：
```json
"currentRangeFilter": "-2%-2%",
"preHighCurrentRangeFilter": "-2%-2%"
```

### 场景4: 筛选接近前高但未突破的股票
枢轴点有涨幅，但相对前高仍有距离：
```json
"currentRangeFilter": "0%-10%",      // 枢轴点有0-10%涨幅
"preHighCurrentRangeFilter": "-5%-0%" // 相对前高还有-5%到0%的空间
```

## 数据来源
这两个字段的数据已在 `adx_filter.py` 的结果CSV文件中计算：
- `当前涨幅`: 枢轴点价格到最后一日收盘价的涨幅
- `前高当前涨幅`: 前高价格（上穿前N天的最高收盘价）到最后一日收盘价的涨幅

## 过滤逻辑
只有当股票同时满足以下条件时才会通过过滤：
1. 原有的涨跌幅过滤条件（`minRange`、`maxRange`）
2. 上穿期间最大涨幅条件（`maxRangeUp`）
3. 前高价格相关条件（`preHighMinRange`、`preHighMaxRange`）
4. 历史低点涨幅条件（`HisLowPointRange`）
5. **当前涨幅条件**（`currentRangeFilter`）← 新增
6. **前高当前涨幅条件**（`preHighCurrentRangeFilter`）← 新增

任何一个条件不满足（且该条件不为`none`），股票都会被过滤掉。

## 修改的文件
1. **configs.json**: 添加了新的配置项
2. **adx_filter.py**: 
   - `filter_results()` 函数: 添加了两个新参数和过滤逻辑
   - `process_single_file()` 函数: 添加了配置解析和参数传递
   - `main()` 函数: 添加了日志输出

## 日志输出
运行 `adx_filter.py` 时，会在日志中显示新的配置信息：
```
ADX过滤配置: ... 当前涨幅区间 -1.00%-10.00%, 前高当前涨幅区间 -1.00%-10.00%
PDI过滤配置: ... 当前涨幅区间 -1.00%-10.00%, 前高当前涨幅区间 -1.00%-10.00%
```

对于被过滤的股票，日志会显示：
```
股票 600000 被过滤: ... (... 当前涨幅不在区间: True, 前高当前涨幅不在区间: False)
```

## 测试方法

### 1. 验证配置加载
```bash
cd /Users/xucang/Desktop/stockIdea
python3 -c "
import json
with open('configs.json', 'r', encoding='utf-8') as f:
    config = json.load(f)
print('currentRangeFilter:', config['ADXfilteringconfig']['currentRangeFilter'])
print('preHighCurrentRangeFilter:', config['ADXfilteringconfig']['preHighCurrentRangeFilter'])
"
```

### 2. 运行过滤程序
```bash
cd /Users/xucang/Desktop/stockIdea
python adx_filter.py --date 2025-10-23
```

### 3. 查看过滤结果
过滤后的结果会保存在 `{日期}-resByFilter` 目录中，包含所有计算字段。

## 注意事项
1. 配置值为 `"none"` 时表示不启用该过滤条件
2. 涨幅范围必须按 `"最小%-最大%"` 格式配置，例如 `"-5%-10%"`
3. 负值表示跌幅，正值表示涨幅
4. 范围的起始值必须小于结束值
5. 这两个过滤条件是**可选的**，默认值为 `"none"`（不过滤）

## 与现有字段的区别

### 当前涨幅 vs 最大涨幅/最小涨幅
- **最大涨幅** (`最大涨幅`): 枢轴点之后的**最高**收盘价相对枢轴点的涨幅
- **最小涨幅** (`最小涨幅`): 枢轴点之后的**最低**收盘价相对枢轴点的涨幅
- **当前涨幅** (`当前涨幅`): **最后一日**收盘价相对枢轴点的涨幅 ← 新增

例如：
- 枢轴点价格: 10元
- 之后最高价: 12元（最大涨幅 +20%）
- 之后最低价: 9元（最小涨幅 -10%）
- 最后一日价格: 10.5元（**当前涨幅 +5%**）

### 前高当前涨幅 vs 前高最大涨幅/前高最小涨幅
- **前高最大涨幅**: 前高价格到枢轴点之后**最高**收盘价的涨幅
- **前高最小涨幅**: 前高价格到枢轴点之后**最低**收盘价的涨幅
- **前高当前涨幅**: 前高价格到**最后一日**收盘价的涨幅 ← 新增

## 后续优化建议
1. 可以考虑添加百分位数配置，例如只筛选当前涨幅在所有股票中前20%的股票
2. 可以添加相对涨幅配置，例如当前涨幅是否超过最大涨幅的50%
3. 可以添加时间衰减因子，根据距离上穿日期的时间给予不同权重

## 版本历史
- v1.0 (2024-10-24): 初始版本，添加 `currentRangeFilter` 和 `preHighCurrentRangeFilter` 配置项

---

**文档版本**: 1.0  
**最后更新**: 2025-10-24  
**维护者**: AI Assistant  
**状态**: ✅ 完整版本

