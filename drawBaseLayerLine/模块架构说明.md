# ç”»çº¿æ¨¡å—æ¶æ„è¯´æ˜

## ğŸ“‹ ç›®å½•ç»“æ„

```
drawBaseLayerLine/
â”œâ”€â”€ draw_lines_base.py      # åŸºç¡€å±‚ç”»çº¿æ¨¡å—
â”œâ”€â”€ draw_lines_mid.py        # ä¸­é—´å±‚ç”»çº¿æ¨¡å—ï¼ˆå¸¦AnchorMçº¿ï¼‰
â”œâ”€â”€ lineConfig.json          # é…ç½®æ–‡ä»¶
â””â”€â”€ æ¨¡å—æ¶æ„è¯´æ˜.md          # æœ¬æ–‡æ¡£
```

## ğŸ—ï¸ æ¨¡å—æ¶æ„

### 1ï¸âƒ£ åŸºç¡€å±‚ (draw_lines_base.py)

**åŠŸèƒ½èŒè´£ï¼š**
- æ•°æ®åŠ è½½å’ŒéªŒè¯
- é˜¶æ®µä½ç‚¹æ£€æµ‹ï¼ˆä½¿ç”¨ZigZagç®—æ³•ï¼‰
- ç”ŸæˆåŸºç¡€Kçº¿å›¾
- ç»˜åˆ¶é˜¶æ®µä½ç‚¹çº¿ï¼ˆè“è‰²ï¼‰
- ç»˜åˆ¶ç™¾åˆ†æ¯”æ¶¨å¹…çº¿ï¼ˆç²‰è‰²è™šçº¿ï¼‰

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `validate_and_load_data()` - æ•°æ®åŠ è½½
- `find_stage_lows_unified()` - é˜¶æ®µä½ç‚¹æ£€æµ‹ï¼ˆZigZag + ä½ç‚¹ä¼˜åŒ–ï¼‰
- `zigzag()` - ZigZagæŒ‡æ ‡ç®—æ³•
- `create_unified_chart()` - åˆ›å»ºåŸºç¡€å›¾è¡¨

**ç‰¹ç‚¹ï¼š**
- ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æ¨¡å—
- æä¾›å®Œæ•´çš„åŸºç¡€ç”»çº¿åŠŸèƒ½
- å¯è¢«å…¶ä»–æ¨¡å—è°ƒç”¨å¤ç”¨

---

### 2ï¸âƒ£ ä¸­é—´å±‚ (draw_lines_mid.py)

**åŠŸèƒ½èŒè´£ï¼š**
- è°ƒç”¨åŸºç¡€å±‚è·å–æ•°æ®å’Œä½ç‚¹
- åœ¨åŸºç¡€å›¾è¡¨ä¸Šæ·»åŠ AnchorMçº¿åˆ†æ
- åŠ¨æ€Må€¼ä¼˜åŒ–å’ŒBåºåˆ—è®¡ç®—
- ä¿æŒä¸åŸºç¡€å±‚ä¸€è‡´çš„é”šå®šä½ç‚¹

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `compute_anchor_M_lines()` - è®¡ç®—æœ€ä½³Må€¼å’ŒBåºåˆ—
- `add_anchor_m_lines_to_chart()` - åœ¨å›¾è¡¨ä¸Šç»˜åˆ¶AnchorMçº¿
- `create_mid_chart()` - åˆ›å»ºä¸­é—´å±‚å›¾è¡¨ï¼ˆåŸºç¡€å›¾ + AnchorMçº¿ï¼‰

**ç‰¹ç‚¹ï¼š**
- ä¾èµ–åŸºç¡€å±‚æ¨¡å—
- ä»£ç å¤ç”¨ï¼šè°ƒç”¨åŸºç¡€å±‚çš„æ‰€æœ‰æ ¸å¿ƒæ–¹æ³•
- ä¸€è‡´æ€§ä¿è¯ï¼šä½¿ç”¨åŸºç¡€å±‚çš„é”šå®šä½ç‚¹

**ä¸åŸºç¡€å±‚çš„å…³ç³»ï¼š**
```python
from draw_lines_base import UnifiedLineDrawer as BaseDrawer

class MidLineDrawer:
    def __init__(self):
        # åˆå§‹åŒ–åŸºç¡€å±‚ç”»çº¿å™¨
        self.base_drawer = BaseDrawer()
        
    def create_mid_chart(self):
        # 1. è°ƒç”¨åŸºç¡€å±‚æ£€æµ‹é˜¶æ®µä½ç‚¹
        stage_lows = self.base_drawer.find_stage_lows_unified(df)
        
        # 2. ä½¿ç”¨åŸºç¡€å±‚çš„æ•°æ®åŠ è½½
        df = self.base_drawer.validate_and_load_data(stock_code, data_dir)
        
        # 3. åœ¨åŸºç¡€å›¾è¡¨ä¸Šæ·»åŠ AnchorMçº¿
        m_lines_result = self.compute_anchor_M_lines(df, anchor_low, anchor_date)
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€å±‚ä½¿ç”¨

```bash
# å¤„ç†æŒ‡å®šæ—¥æœŸçš„è‚¡ç¥¨ï¼ˆåªç”ŸæˆåŸºç¡€å›¾è¡¨ï¼‰
cd drawBaseLayerLine
python draw_lines_base.py --date 2025-10-20 --workers 4

# è¾“å‡ºç›®å½•: {date}-drawLineRes/
```

### ä¸­é—´å±‚ä½¿ç”¨

```bash
# å¤„ç†æŒ‡å®šæ—¥æœŸçš„è‚¡ç¥¨ï¼ˆç”ŸæˆåŸºç¡€å›¾è¡¨ + AnchorMçº¿ï¼‰
cd drawBaseLayerLine
python draw_lines_mid.py --date 2025-10-20 --workers 4

# è¾“å‡ºç›®å½•: {date}-drawLineMid/
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶ (lineConfig.json)

```json
{
  "percent_dic": ["3%", "16%", "25%", ...],
  "zigzag_period": 49,
  "zigzag_threshold": 0.05,
  "anchorMLines": {
    "enabled": true,
    "zigzag_percent": 10,
    "pivot_window": 3,
    "m_range": {
      "start": 13.0,
      "end": 9.0,
      "step": -0.1
    },
    "max_k": 20,
    "match_tolerance_ratio": 0.006,
    "min_matches": 3,
    "tiebreaker_prefer_higher_M": true,
    "line_style": {
      "color": "#8A2BE2",
      "linewidth": 3.0,
      "alpha": 0.9
    },
    "text_style": {
      "fontsize": 14,
      "x_offset": 5
    },
    "annotate_format": "K={K} ä»·æ ¼={price}"
  }
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `zigzag_period`: åŸºç¡€å±‚é˜¶æ®µä½ç‚¹æ£€æµ‹çš„ZigZagé˜ˆå€¼ï¼ˆ49è¡¨ç¤º49%ï¼‰
- `anchorMLines.enabled`: æ˜¯å¦å¯ç”¨AnchorMçº¿åŠŸèƒ½
- `anchorMLines.zigzag_percent`: ä¸­é—´å±‚Må€¼è¯„åˆ†æ—¶çš„å°çº§åˆ«ZigZagé˜ˆå€¼ï¼ˆ10è¡¨ç¤º10%ï¼‰
- `anchorMLines.m_range`: Må€¼æœç´¢èŒƒå›´ï¼ˆä»13.0%åˆ°9.0%ï¼Œæ­¥é•¿-0.1%ï¼‰

---

## ğŸ”„ æ•°æ®æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
   â†“
ä¸­é—´å±‚ (draw_lines_mid.py)
   â†“
è°ƒç”¨åŸºç¡€å±‚ (draw_lines_base.py)
   â”œâ”€ æ•°æ®åŠ è½½ (validate_and_load_data)
   â”œâ”€ é˜¶æ®µä½ç‚¹æ£€æµ‹ (find_stage_lows_unified)
   â”‚   â””â”€ ZigZagç®—æ³• (zigzag)
   â””â”€ è¿”å›: df, stage_lows
   â†“
ä¸­é—´å±‚ç»§ç»­å¤„ç†
   â”œâ”€ é‡æ–°ç”ŸæˆåŸºç¡€å›¾è¡¨
   â”‚   â”œâ”€ Kçº¿å›¾
   â”‚   â”œâ”€ é˜¶æ®µä½ç‚¹çº¿ï¼ˆè“è‰²ï¼‰
   â”‚   â””â”€ ç™¾åˆ†æ¯”æ¶¨å¹…çº¿ï¼ˆç²‰è‰²è™šçº¿ï¼‰
   â”œâ”€ è®¡ç®—AnchorMçº¿ (compute_anchor_M_lines)
   â”‚   â”œâ”€ å°çº§åˆ«ZigZagåˆ†æ
   â”‚   â”œâ”€ å±€éƒ¨æå€¼æå–
   â”‚   â”œâ”€ Må€¼éå†å’Œè¯„åˆ†
   â”‚   â””â”€ é€‰æ‹©æœ€ä½³Må€¼
   â””â”€ ç»˜åˆ¶AnchorMçº¿ï¼ˆç´«è‰²ï¼‰
   â†“
è¾“å‡ºæœ€ç»ˆå›¾è¡¨
```

---

## âœ¨ å…³é”®ç‰¹æ€§

### 1. æ¨¡å—åŒ–è®¾è®¡
- åŸºç¡€å±‚å’Œä¸­é—´å±‚åˆ†ç¦»
- æ¯å±‚ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½
- æ˜“äºç»´æŠ¤å’Œæ‰©å±•

### 2. ä»£ç å¤ç”¨
- ä¸­é—´å±‚è°ƒç”¨åŸºç¡€å±‚æ–¹æ³•
- é¿å…é‡å¤ä»£ç 
- ä¿è¯é€»è¾‘ä¸€è‡´æ€§

### 3. ä¸€è‡´æ€§ä¿è¯
- ä½¿ç”¨ç›¸åŒçš„é”šå®šä½ç‚¹æ£€æµ‹é€»è¾‘
- åŸºç¡€å±‚çš„ `find_stage_lows_unified()` ç¡®ä¿é”šç‚¹ä¸€è‡´
- ZigZagå‚æ•°ç»Ÿä¸€é…ç½®åœ¨ `lineConfig.json`

### 4. çµæ´»æ€§
- å¯å•ç‹¬è¿è¡ŒåŸºç¡€å±‚ï¼ˆä¸éœ€è¦AnchorMçº¿ï¼‰
- å¯è¿è¡Œä¸­é—´å±‚ï¼ˆåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼‰
- é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶åŠŸèƒ½å¼€å…³

---

## ğŸ“Š è¾“å‡ºå¯¹æ¯”

### åŸºç¡€å±‚è¾“å‡º
- **æ–‡ä»¶å**: `{prefix}_{code}_{name}.png`
- **å†…å®¹**:
  - Kçº¿å›¾ï¼ˆçº¢æ¶¨ç»¿è·Œï¼‰
  - é˜¶æ®µä½ç‚¹çº¿ï¼ˆè“è‰²æ°´å¹³çº¿ï¼‰
  - ç™¾åˆ†æ¯”æ¶¨å¹…çº¿ï¼ˆç²‰è‰²è™šçº¿ï¼‰

### ä¸­é—´å±‚è¾“å‡º
- **æ–‡ä»¶å**: `{prefix}_{code}_{name}.png`
- **å†…å®¹**:
  - åŸºç¡€å±‚çš„æ‰€æœ‰å†…å®¹
  - **+ AnchorMçº¿ï¼ˆç´«è‰²æ°´å¹³çº¿ï¼‰**
  - **+ Kå€¼æ ‡æ³¨ï¼ˆå·¦ä¾§ï¼‰**
  - **+ Må€¼ä¿¡æ¯æ¡†ï¼ˆå·¦ä¸Šè§’ï¼‰**

---

## ğŸ”§ å¼€å‘æ³¨æ„äº‹é¡¹

### ä¿®æ”¹åŸºç¡€å±‚æ—¶
1. ç¡®ä¿ä¸ç ´åç°æœ‰API
2. ä¿æŒ `find_stage_lows_unified()` çš„è¿”å›æ ¼å¼
3. æµ‹è¯•åŸºç¡€å±‚ç‹¬ç«‹è¿è¡Œ

### ä¿®æ”¹ä¸­é—´å±‚æ—¶
1. ä¼˜å…ˆä½¿ç”¨åŸºç¡€å±‚çš„æ–¹æ³•
2. ä¸è¦é‡å¤å®ç°åŸºç¡€å±‚å·²æœ‰åŠŸèƒ½
3. ç¡®ä¿AnchorMçº¿ä½¿ç”¨åŸºç¡€å±‚æä¾›çš„é”šç‚¹

### æ·»åŠ æ–°åŠŸèƒ½å±‚æ—¶
1. ç»§ç»­éµå¾ªåˆ†å±‚æ¶æ„
2. è°ƒç”¨ä¸‹å±‚æ¨¡å—çš„æ–¹æ³•
3. æ¯å±‚ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½

---

## ğŸ“ æœªæ¥æ‰©å±•

å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šå±‚æ¬¡ï¼š

```
draw_lines_base.py    # åŸºç¡€å±‚ï¼šKçº¿ + é˜¶æ®µä½ç‚¹ + ç™¾åˆ†æ¯”çº¿
   â†“
draw_lines_mid.py     # ä¸­é—´å±‚ï¼šåŸºç¡€å±‚ + AnchorMçº¿
   â†“
draw_lines_top.py     # é¡¶å±‚ï¼šä¸­é—´å±‚ + å…¶ä»–æŠ€æœ¯æŒ‡æ ‡
```

æ¯ä¸€å±‚éƒ½è°ƒç”¨ä¸‹å±‚çš„æ–¹æ³•ï¼Œé€æ­¥å åŠ åŠŸèƒ½ã€‚

---

## ğŸ‰ æ€»ç»“

âœ… **æ¨¡å—åŒ–æ¶æ„** - æ¸…æ™°çš„å±‚æ¬¡ç»“æ„  
âœ… **ä»£ç å¤ç”¨** - é¿å…é‡å¤å®ç°  
âœ… **ä¸€è‡´æ€§** - ä½¿ç”¨ç»Ÿä¸€çš„é”šå®šé€»è¾‘  
âœ… **çµæ´»æ€§** - å¯ç‹¬ç«‹æˆ–ç»„åˆä½¿ç”¨  
âœ… **å¯æ‰©å±•** - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å±‚

