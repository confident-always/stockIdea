# 统一版基础层画线脚本 (draw_lines_unified.py)

## 概述

`draw_lines_unified.py` 是一个整合了所有 drawBaseLayerLine 功能的单一可执行脚本，通过一个命令行即可输出完整的股票技术分析图表。该脚本整合了原有的多个脚本功能，提供了更加便捷和高效的使用体验。

## 主要功能

### 🎯 核心特性
- **单一脚本执行**: 整合所有功能，无需运行多个脚本
- **智能数据验证**: 多层数据验证和清洗机制
- **多算法融合**: 结合多种算法检测阶段低点
- **高质量图表**: 生成高分辨率的技术分析图表
- **多线程处理**: 支持并发处理，提高执行效率
- **完整错误处理**: 详细的日志记录和错误处理机制

### 📊 技术分析功能
1. **K线图绘制**: 显示股票的开高低收价格走势
2. **阶段低点检测**: 使用多种算法识别重要的支撑位
3. **水平支撑线**: 在阶段低点绘制蓝色水平线并标注价格
4. **百分比涨幅线**: 根据配置绘制不同百分比的目标价位线
5. **技术指标辅助**: 结合RSI等技术指标优化低点检测

## 安装要求

### Python 依赖
```bash
pip install pandas numpy matplotlib scipy
```

### 系统要求
- Python 3.7+
- macOS/Linux/Windows
- 至少 2GB 可用内存（用于大批量处理）

## 使用方法

### 基本语法
```bash
python draw_lines_unified.py [选项]
```

### 命令行参数

#### 必选参数（二选一）
- `--stock STOCK`: 处理单只股票（指定股票代码）
- `--all`: 批量处理所有股票

#### 可选参数
- `--output OUTPUT`: 输出目录（默认: drawLineRes）
- `--data-dir DATA_DIR`: 数据目录（默认: ../data）
- `--workers WORKERS`: 线程数（默认: 4）
- `--config CONFIG`: 配置文件（默认: lineConfig.json）

### 使用示例

#### 1. 处理单只股票
```bash
# 处理股票代码为 002895 的股票
python draw_lines_unified.py --stock 002895

# 指定输出目录
python draw_lines_unified.py --stock 002895 --output my_charts
```

#### 2. 批量处理所有股票
```bash
# 使用默认设置批量处理
python draw_lines_unified.py --all --workers 8

# 指定输出目录和线程数
python draw_lines_unified.py --all --output batch_results --workers 8

# 从指定数据目录读取
python draw_lines_unified.py --all --data-dir /path/to/data --workers 6
```

#### 3. 自定义配置
```bash
# 使用自定义配置文件
python draw_lines_unified.py --all --config my_config.json

# 完整参数示例
python draw_lines_unified.py --all \
    --output production_charts \
    --data-dir /data/stocks \
    --workers 8 \
    --config production_config.json
```

## 配置文件

### lineConfig.json 格式
```json
{
  "percent_dic": [
    "3%", "16%", "25%", "34%", "50%", 
    "67%", "128%", "228%", "247%", "323%", 
    "457%", "589%", "636%", "770%", "823%", "935%"
  ]
}
```

### 配置说明
- `percent_dic`: 百分比涨幅线配置，用于在图表中绘制不同百分比的目标价位线
- 如果配置文件不存在，脚本会使用内置的默认配置

## 数据要求

### 输入数据格式
脚本需要 CSV 格式的股票数据，包含以下必要列：
- `date`: 日期（YYYY-MM-DD 格式）
- `open`: 开盘价
- `high`: 最高价
- `low`: 最低价
- `close`: 收盘价

### 数据目录结构
```
data/
├── 000001.csv
├── 000002.csv
├── 002895.csv
└── ...
```

### 股票信息来源
脚本会自动从以下位置获取股票名称信息：
1. `../resByFilter/` 目录下的 CSV 文件
2. 如果找不到，则使用股票代码作为名称

## 输出结果

### 图表文件
- **格式**: PNG 图片
- **分辨率**: 200 DPI 高清
- **尺寸**: 20x12 英寸
- **命名**: `{股票代码}_{股票名称}.png`

### 处理结果文件
批量处理时会生成 `processing_results.json` 文件，包含：
```json
{
  "stock_code": "002895",
  "stock_name": "川恒股份", 
  "success": true,
  "elapsed_time": 1.33,
  "error": null,
  "stage_lows_count": 10
}
```

### 日志文件
- **文件名**: `draw_lines_unified.log`
- **内容**: 详细的处理日志，包括成功、失败和错误信息

## 性能优化

### 多线程处理
- 默认使用 4 个线程
- 可通过 `--workers` 参数调整
- 建议设置为 CPU 核心数的 1-2 倍

### 内存使用
- 单只股票处理约需 50-100MB 内存
- 批量处理时内存使用量 = 线程数 × 单股票内存需求
- 建议大批量处理时适当减少线程数

### 处理速度
- 单只股票平均处理时间: 1-3 秒
- 批量处理速度: 约 2-5 只/秒（取决于硬件配置）

## 故障排除

### 常见问题

#### 1. 字体警告
```
Font family 'SimHei' not found
```
**解决方案**: 这是正常现象，脚本会自动使用英文字体，不影响功能。

#### 2. 数据文件不存在
```
数据文件不存在: /path/to/stock.csv
```
**解决方案**: 
- 检查数据目录路径是否正确
- 确认股票代码对应的 CSV 文件存在
- 使用 `--data-dir` 参数指定正确的数据目录

#### 3. 图表创建失败
```
图表创建失败
```
**解决方案**:
- 检查输出目录是否有写入权限
- 确认数据质量（至少需要 100 天的有效数据）
- 查看详细日志文件了解具体错误

#### 4. 内存不足
**解决方案**:
- 减少线程数: `--workers 2`
- 分批处理股票
- 增加系统内存

### 调试模式
如需查看详细调试信息，可以修改脚本中的日志级别：
```python
logging.basicConfig(level=logging.DEBUG)
```

## 技术架构

### 核心算法

#### 阶段低点检测算法
1. **全局最低点**: 必须包含的绝对最低价
2. **滑动窗口检测**: 使用多个时间窗口（20、40、60天）检测局部低点
3. **价格分位数**: 基于价格分布的低点识别
4. **技术指标辅助**: 结合 RSI 超卖区域优化检测
5. **智能去重**: 避免过于密集的低点

#### 数据验证机制
1. **文件完整性**: 检查文件存在性和大小
2. **数据完整性**: 验证必要列和数据行数
3. **数据合理性**: 检查价格逻辑和数值范围
4. **数据清洗**: 自动过滤异常数据

### 性能优化策略
1. **多线程并发**: 使用 ThreadPoolExecutor 实现并发处理
2. **内存管理**: 及时释放图表对象，避免内存泄漏
3. **IO 优化**: 批量文件操作，减少磁盘 IO
4. **算法优化**: 向量化计算，提高数值处理效率

## 版本历史

### v1.0.0 (当前版本)
- ✅ 整合所有 drawBaseLayerLine 功能
- ✅ 实现命令行参数支持
- ✅ 多线程批量处理
- ✅ 完整的错误处理和日志记录
- ✅ 高质量图表生成
- ✅ 智能数据验证和清洗

## 与原版本对比

| 功能 | 原版本 | 统一版本 |
|------|--------|----------|
| 脚本数量 | 多个脚本 | 单一脚本 |
| 命令行支持 | 有限 | 完整支持 |
| 错误处理 | 基础 | 完善 |
| 数据验证 | 简单 | 多层验证 |
| 算法融合 | 单一算法 | 多算法融合 |
| 性能优化 | 基础 | 高度优化 |
| 日志记录 | 简单 | 详细完整 |

## 技术支持

如遇到问题或需要技术支持，请：
1. 查看日志文件 `draw_lines_unified.log`
2. 检查 `processing_results.json` 中的错误信息
3. 确认数据格式和配置文件正确性
4. 参考本文档的故障排除部分

---

**注意**: 本脚本为股票技术分析工具，生成的图表仅供参考，不构成投资建议。投资有风险，决策需谨慎。