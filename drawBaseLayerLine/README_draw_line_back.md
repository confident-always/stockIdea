# draw_line_back.py - AnchorBack画线脚本

## 功能概述

`draw_line_back.py` 是一个基于 **AnchorBack算法** 的K线图表生成脚本，与 `draw_lines_mid.py`（AnchorM算法）形成对比。

##核心算法：AnchorBack

### 算法公式

```
B_k = A + N × K
```

其中：
- **A**: 锚定低点附近5根K线收盘价中的**最低收盘价**
- **N**: 步长参数 (范围: 0.23 ~ 0.68, 步长: 0.01)
- **K**: 奇数序列 (1, 3, 5, 7, 9, 11, 13, 15, 17, 19)

### 与AnchorM的区别

| 特性 | AnchorBack | AnchorM |
|------|-----------|---------|
| 算法公式 | `B = A + N × K` (加法) | `B = A × (1 + M × k)` (乘法) |
| 参数名称 | N (步长) | M (百分比) |
| 参数范围 | 0.23 ~ 0.68 | 9.0% ~ 13.0% |
| K值序列 | 奇数 (1,3,5...) | 连续整数 (1,2,3...) |
| 线条颜色 | 蓝色 (#1E90FF) | 紫色 (#8A2BE2) |
| 锚定点A | 5根K线窗口内最低**收盘价** | 5根K线窗口内最低**收盘价** |

##使用方法

### 基本用法

```bash
# 处理指定日期的股票
python draw_line_back.py --date 2025-10-22

# 指定线程数
python draw_line_back.py --date 2025-10-22 --workers 4
```

### 配置文件

脚本使用 `lineConfig.json` 中的 `anchorBackLines` 配置：

```json
"anchorBackLines": {
    "enabled": true,
    "zigzag_percent": 15,
    "time_decay_min_weight": 0.3,
    "pivot_window": 5,
    "n_range": {
        "start": 0.23,
        "end": 0.68,
        "step": 0.01
    },
    "k_list": [1, 3, 5, 7, 9, 11, 13, 15, 17, 19],
    "match_tolerance_ratio": 0.006,
    "min_matches": 1,
    "tiebreaker_prefer_higher_N": true,
    "line_style": {
        "color": "#1E90FF",
        "linewidth": 3.0,
        "alpha": 0.9
    }
}
```

## 输出说明

### 图表元素

1. **蓝色横线**: AnchorBack线（`B_k = A + N × K`）
2. **左侧蓝色标签**: K值和价格 (如 "K=1 价格=6.45")
3. **锚定点标注**: 
   - 红色圆点（白色边框）标记最低收盘价位置
   - 黄色标签显示 "Anchor {price}"
   - 红色箭头指向锚定点
4. **右侧蓝色标签**: 阶段低点价格
5. **右侧棕色标签**: 百分比涨幅线 (+3%, +16%, +25%...)
6. **左上角信息框**: 
   - N值
   - Match_B数组（匹配的K值、价格、得分）
   - 平均得分
   - 匹配数量

### 输出目录

```
{日期}-drawLineBack/
  ├── ADX105_002064_华峰化学.png
  ├── PDI39_600323_瀚蓝环境.png
  └── ...
```

## 算法详解

### 1. 锚定点确定

1. 使用ZigZag(49%)算法找到阶段性低点
2. 在该低点前后5根K线窗口内
3. 取所有**收盘价**中的最小值作为锚定点A

**为什么用收盘价？**
- 收盘价代表当天买卖双方最终共识
- 比最低价（可能是盘中瞬时价格）更稳定
- 更适合作为支撑位参考

### 2. N值遍历与评分

1. 对每个N值（0.23 ~ 0.68），生成B序列：
   ```
   B_1 = A + N × 1
   B_3 = A + N × 3
   B_5 = A + N × 5
   ...
   ```

2. 使用ZigZag(15%)算法找到锚定点后的转折点
3. 提取转折点附近的局部极值：
   - **高点转折**: 取窗口内最高价
   - **低点转折**: 取窗口内最低收盘价

4. 计算匹配得分：
   - 对每个B_k，找最近的两个极值点
   - 计算价格相似度得分（容差0.6%）
   - 应用时间衰减因子（离锚定点越近权重越高）

5. 选择平均得分最高的N值

### 3. 图表绘制

1. 显示范围：从锚定低点开始（确保锚定点可见）
2. 绘制蓝色AnchorBack线
3. 标注锚定点（红色圆点+黄色标签）
4. 添加K值标签和信息框

## 实战应用

### 场景1：验证算法起点
- 查看红色锚定点位置
- 确认是最低收盘价
- 理解所有蓝色线从这里开始

### 场景2：判断支撑强度
- 如果当前价格接近某条蓝色线
- 且该线有高匹配得分（如K3, K7匹配）
- 该价位可能是支撑位

### 场景3：识别突破信号
- 价格突破多条蓝色线
- 且锚定点已远离
- 可能是上涨趋势确立

### 场景4：对比两种算法
- 同时查看蓝色线图（AnchorBack）
- 和紫色线图（AnchorM）
- 找共同匹配的价位
- 作为更可靠的交易参考

## 成功案例

### 案例1：603036 如通股份
- 锚定点A=8.29 (2024-02-07)
- 最佳N=0.65
- 匹配10个K值：K1, K3, K7, K12, K15, K17, K19等
- 平均得分18.4分

### 案例2：002082 万邦德
- 锚定点A=3.93 (2024-02-07)
- 最佳N=0.31
- 匹配10个K值
- 价格沿蓝色线运行，验证了支撑位有效性

## 注意事项

1. **锚定点可见性**: 
   - 大部分股票能成功显示锚定点标注
   - 少数股票因锚定点太早（超出750根K线限制）而不显示

2. **K线数量限制**:
   - 最多显示750根K线（避免图表过于密集）
   - 如果数据超过750根，会截取最近的750根

3. **ZigZag参数**:
   - 阶段低点检测：49%
   - 转折点匹配：15%（可在`lineConfig.json`中调整）

4. **中文字体**:
   - 锚定点标签使用英文 "Anchor" 避免乱码
   - 其他中文文字（标题、行业）显示正常

## 技术参数

- **图表尺寸**: 3991 × 2392 像素
- **线程数**: 默认4，可通过`--workers`参数调整
- **输出格式**: PNG
- **字体**: Heiti TC, PingFang HK, Arial Unicode MS
- **配色方案**: 红涨绿跌，蓝色AnchorBack线

## 文件说明

- `draw_line_back.py`: 主脚本
- `lineConfig.json`: 配置文件
- `draw_line_back.log`: 运行日志
- `stocklist.csv`: 股票基础信息（名称、行业、PE、总股本等）

## 更新日志

### 2025-10-23
- ✅ 创建AnchorBack画线脚本
- ✅ 实现 `B = A + N × K` 算法
- ✅ 添加锚定点标注（红色圆点+黄色标签）
- ✅ 修复显示范围问题，确保锚定点可见
- ✅ 优化图层顺序（zorder=10）
- ✅ 完成245只股票的测试

## 与draw_lines_mid.py的对比

| 项目 | draw_line_back.py | draw_lines_mid.py |
|------|------------------|-------------------|
| 算法 | AnchorBack (加法) | AnchorM (乘法) |
| 线条颜色 | 蓝色 | 紫色 |
| 信息框颜色 | 蓝色 | 紫色 |
| K值序列 | 奇数 | 连续 |
| 参数名 | N (步长) | M (百分比) |
| 配置节 | anchorBackLines | anchorMLines |
| 日志文件 | draw_line_back.log | draw_lines_mid.log |
| 输出目录 | {date}-drawLineBack | {date}-drawLineMid |

## 建议

1. **同时使用两种算法**:
   - 加法模型（AnchorBack）和乘法模型（AnchorM）
   - 提供不同视角的支撑/阻力位分析
   
2. **关注共同匹配点**:
   - 如果两种算法都在某个价位匹配到高分
   - 该价位可能是更可靠的支撑/阻力位

3. **结合实际走势**:
   - 观察价格是否沿线条运行
   - 验证算法的有效性

---

**作者**: AI Assistant  
**日期**: 2025-10-23  
**版本**: 1.0
