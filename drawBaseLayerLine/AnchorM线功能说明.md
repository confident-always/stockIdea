# AnchorM线功能说明

## 功能概述

AnchorM线功能是一个动态M值优化系统,通过遍历不同的M值(13.0%到9.0%),计算B序列并与ZigZag拐点附近的极值进行匹配评分,自动选择最佳M值并在图表上绘制相应的紫色横线标注。

**v2.0 新增特性**:
- ⏰ **时间衰减因子**: 离锚定点越近的极值点得分权重越高,更关注近期价格行为
- 🎯 **智能匹配调整**: 根据数据量自动调整匹配数要求
- 📈 **K值自动扩展**: 完全覆盖所有K线并额外绘制3根预测线
- 🎨 **优化显示**: 左上角信息框,只显示匹配的B值及得分

## 核心算法

### 1. 锚点确定
- 使用现有的阶段低点检测逻辑(ZigZag 49%)
- 锚点低价A = 阶段低点价格
- 锚定日期 = 阶段低点日期

### 2. 小级别ZigZag计算
- 参数p: 默认10%(可配置)
- 在锚定日期之后的数据中计算ZigZag转折点
- 提取拐点附近窗口(±3个交易日)的局部极值

### 3. M值遍历与B序列生成
- M值范围: 13.0% → 9.0%, 步长0.1%
- B序列公式: B_k = A + (A × M) × k
  - k = 1, 2, 3, ... 最多20个
  - 停止条件: B_k > 最高价 × 1.01

### 4. 匹配与评分（含时间衰减因子）
对每个B_k:
- 找到最接近的两个极值(一上一下)
- 计算基础得分:
  - 相对差: r = |E - B_k| / B_k
  - 基础得分: base_score = 100 × max(0, 1 - min(r / 0.006, 1))
- 应用时间衰减权重:
  - 时间权重: time_weight = 1.0 - (1.0 - min_weight) × (idx / max_idx)
  - idx: 极值点距锚定点的天数
  - min_weight: 最小权重(默认0.3)
- 最终得分: final_score = base_score × time_weight
- B_k得分 = 选中极值的加权平均得分

时间衰减规则:
- 锚定点附近(idx≈0): 权重 ≈ 1.0 (100%)
- 中间位置(idx≈max/2): 权重 ≈ 0.65 (65%)
- 最远位置(idx=max): 权重 = min_weight (30%)

M值总分:
- 平均得分 = 所有B_k加权得分的平均值
- 匹配数 = 得分>0的B_k数量

### 5. 最佳M选择
- 过滤: 匹配数 < 3的M值被排除
- 排序: 优先平均得分,其次匹配数,最后M值大小
- 选择: 得分最高的M值

## 配置参数 (lineConfig.json)

```json
{
  "anchorMLines": {
    "enabled": true,                      // 启用/禁用功能
    "zigzag_percent": 10,                 // 小级别ZigZag阈值(%)
    "time_decay_min_weight": 0.3,         // 时间衰减最小权重(0-1)
                                          // 0.3 - 中等衰减(默认,推荐)
                                          // 0.5 - 温和衰减(兼顾历史)
                                          // 0.1 - 强烈衰减(重视近期)
                                          // 1.0 - 无衰减(等同原算法)
    "pivot_window": 3,                    // 拐点窗口大小
    "m_range": {
      "start": 13.0,                      // M值起始(%)
      "end": 9.0,                         // M值结束(%)
      "step": -0.1                        // M值步长(%)
    },
    "max_k": 20,                          // 最大K值(已自动扩展,无实际限制)
    "match_tolerance_ratio": 0.006,       // 匹配容差(0.6%)
    "min_matches": 3,                     // 最小匹配数要求(自动智能调整)
    "tiebreaker_prefer_higher_M": true,   // 并列时优先更大M
    "line_style": {
      "color": "#8A2BE2",                 // 线条颜色(紫色)
      "linewidth": 3.0,                   // 线宽
      "alpha": 0.9                        // 透明度
    },
    "text_style": {
      "fontsize": 14,                     // 字号
      "x_offset": 5                       // X轴偏移
    },
    "annotate_format": "K={K} 价格={price}",  // 标注格式
    "anchor_fallback_window_days": 60     // 回退窗口(天)
  }
}
```

## 输出内容

### 1. 图表上的紫色横线
- 显示用于评分的小级别极值
- 每条横线对应一个匹配的极值价格
- 线旁标注: "K=X 价格=Y.YY"

### 2. 左上角信息框
```
M=11.1%
Match_B: [13.79(34), 17.92(27), ...]
AvgScore: 8.7
Matches: 2/7
```
说明:
- M值: 选出的最佳M百分比
- Match_B: 只显示匹配的B值及其得分
- AvgScore: 平均得分(含时间衰减后的加权得分)
- Matches: 有效匹配数/总B值数

### 3. JSON结果
保存在 `processing_results.json` 中:
```json
{
  "stock_code": "002603",
  "stock_name": "以岭药业",
  "success": true,
  "anchorMLines": {
    "best_M": 11.1,
    "avg_score": 8.7,
    "matches_count": 2,
    "scores": [
      {"B_k": 13.79, "score": 34},
      {"B_k": 17.92, "score": 27}
    ],
    "anchor_low": 12.41,
    "anchor_date": "2025-04-09"
  }
}
```
注: scores数组只保存有效匹配(得分>0)的B值及其得分

## 使用方法

### 基本用法
```bash
# 默认处理(功能自动启用,含时间衰减)
cd drawBaseLayerLine
python draw_lines_mid.py --date 2025-10-21 --workers 4
```

### 禁用M线功能
修改 `lineConfig.json`:
```json
{
  "anchorMLines": {
    "enabled": false
  }
}
```

### 调整参数
```json
{
  "anchorMLines": {
    "zigzag_percent": 5,          // 更灵敏的小级别ZigZag
    "time_decay_min_weight": 0.5, // 温和衰减,更兼顾历史数据
    "min_matches": 5,             // 更严格的匹配要求(会自动调整)
    "match_tolerance_ratio": 0.01 // 更宽松的容差(1%)
  }
}
```

## 技术实现

### 核心函数
1. `zigzag()` - 计算ZigZag转折点
2. `get_local_extremes_around_turns()` - 提取拐点附近极值
3. `generate_B_series()` - 生成B序列(自动扩展到覆盖所有K线+3根)
4. `score_M()` - M值评分(含时间衰减因子)
5. `select_best_M()` - 选择最佳M
6. `compute_anchor_M_lines()` - 主计算函数
7. `find_stage_lows_unified()` - 阶段低点检测(含优化)

### 绘图集成
- 在 `create_mid_chart()` 中集成
- 使用 `ax.axhline()` 绘制横线
- 使用 `ax.text()` 在左侧添加K值标注
- 使用 `ax.text()` 在左上角添加M值信息框
- 线程安全,支持多线程处理

## 性能特点

- **线程安全**: 无共享可变状态
- **高效计算**: O(n)时间复杂度
- **智能调整**:
  - K值自动扩展(覆盖所有K线+3根)
  - 匹配数自动调整(数据少时降低要求)
  - 时间衰减自动应用
- **鲁棒性强**: 
  - 数据不足时安全退出(附详细日志)
  - 无匹配时不绘制
  - 异常捕获不中断流程

## 应用场景

### 场景1: 震荡市场
- 小级别ZigZag捕捉频繁转折
- M值评分识别主要支撑/压力位
- 紫色横线标注关键价格点

### 场景2: 趋势市场
- 较大的M值(接近13%)匹配趋势
- 较少的匹配点(3-5个)
- 清晰的上升通道

### 场景3: 数据不足(智能处理)
- 锚定日期后数据<10天: 跳过(日志提示)
- ZigZag无转折点: 跳过(日志提示)
- 数据<200天: 自动降低最小匹配数(3→2)
- 匹配数不足: 跳过并显示实际匹配数

## 测试结果

### 002603 以岭药业(含时间衰减)
- 锚点: 2025-04-09, 12.41元
- 锚定后数据: 129天
- 最佳M: 11.1%
- 平均得分: 8.7(时间衰减后)
- 匹配: 2/7
- 匹配B值: 13.79(34分), 17.92(27分)
- 智能调整: 最小匹配数 3→2
- ✅ 功能正常,时间衰减生效

### 时间衰减效果对比
无时间衰减:
- 平均得分: 15.5
- 13.79元得分: 45
- 17.92元得分: 63

含时间衰减(0.3):
- 平均得分: 8.7 (↓44%)
- 13.79元得分: 34 (↓24%)
- 17.92元得分: 27 (↓57%)

说明: 远期极值点(17.92)衰减更明显,符合预期

## 调优建议

### 提高灵敏度(捕捉更多细节)
```json
{
  "zigzag_percent": 5,           // 更小阈值,更多转折点
  "time_decay_min_weight": 0.2,  // 强烈衰减,重视近期
  "min_matches": 2,              // 降低要求(会自动调整)
  "match_tolerance_ratio": 0.01  // 放宽容差
}
```

### 提高准确性(筛选高质量)
```json
{
  "zigzag_percent": 15,          // 更大阈值,主要转折
  "time_decay_min_weight": 0.5,  // 温和衰减,兼顾历史
  "min_matches": 5,              // 提高要求
  "match_tolerance_ratio": 0.003 // 收紧容差
}
```

### 重视近期行为
```json
{
  "time_decay_min_weight": 0.1,  // 强烈衰减
  "zigzag_percent": 8            // 适中阈值
}
```

### 兼顾历史规律
```json
{
  "time_decay_min_weight": 0.6,  // 温和衰减
  "zigzag_percent": 12           // 较大阈值
}
```

### 调整M值范围
```json
{
  "m_range": {
    "start": 15.0,    // 更大M值
    "end": 8.0,       // 更小M值
    "step": -0.05     // 更细步长(计算量翻倍)
  }
}
```

## 注意事项

1. **计算开销**: M值遍历会增加计算时间(约+10-20%)
2. **视觉效果**: 
   - 紫色横线已优化(加粗,左侧标注)
   - 信息框移至左上角
   - 只显示匹配的B值及得分
3. **数据质量**: 依赖高质量的K线数据
4. **参数调优**: 不同市场环境需要不同参数
5. **时间衰减**: 
   - 默认0.3适合大多数场景
   - 设为1.0可禁用时间衰减
   - 调整时注意平均得分会相应变化
6. **智能特性**:
   - K值自动扩展,无需担心上限
   - 匹配数自动调整,数据少时自动降低要求

## 未来优化方向

1. ~~自适应M值范围(根据市场波动率)~~
2. ~~多级别M线(不同时间周期)~~
3. M值趋势分析(M值随时间变化)
4. 机器学习优化参数
5. ~~时间衰减因子~~ ✅ 已实现(v2.0)
6. 非线性时间衰减(指数衰减、对数衰减等)

## 更新日志

### v2.0 (2025-10-21)
✅ **时间衰减因子**: 
- 加入时间维度权重,近期极值点得分更高
- 可配置衰减强度(time_decay_min_weight)
- 默认0.3,兼顾近期和历史

✅ **智能匹配数调整**:
- 根据锚定后数据量自动调整min_matches
- 数据<200天: 3→2, 避免过度筛选

✅ **K值自动扩展**:
- 解除max_k=20限制
- 自动覆盖所有K线+3根预测线
- 安全上限500防止极端情况

✅ **显示优化**:
- 信息框移至左上角
- 只显示匹配的B值及得分
- K值标注加粗放大,移至左侧

### v1.0 (2025-10-20)
- 初始版本
- 基础M线功能
- ZigZag匹配评分

---

**版本**: 2.0  
**日期**: 2025-10-21  
**状态**: ✅ 已实现并测试通过(含时间衰减)
