# AnchorM线功能说明

## 功能概述

AnchorM线功能是一个动态M值优化系统,通过遍历不同的M值(13.0%到9.0%),计算B序列并与ZigZag拐点附近的极值进行匹配评分,自动选择最佳M值并在图表上绘制相应的紫色横线标注。

## 核心算法

### 1. 锚点确定
- 使用现有的阶段低点检测逻辑(ZigZag 49%)
- 锚点低价A = 阶段低点价格
- 锚定日期 = 阶段低点日期

### 2. 小级别ZigZag计算
- 参数p: 默认10%(可配置)
- 在锚定日期之后的数据中计算ZigZag转折点
- 提取拐点附近窗口(±3个交易日)的局部极值

### 3. M值遍历与B序列生成
- M值范围: 13.0% → 9.0%, 步长0.1%
- B序列公式: B_k = A + (A × M) × k
  - k = 1, 2, 3, ... 最多20个
  - 停止条件: B_k > 最高价 × 1.01

### 4. 匹配与评分
对每个B_k:
- 找到最接近的两个极值(一上一下)
- 计算相对差: r = |E - B_k| / B_k
- 单点得分: s_e = 100 × max(0, 1 - min(r / 0.006, 1))
- B_k得分 = 选中极值的平均得分

M值总分:
- 平均得分 = 所有B_k得分的平均值
- 匹配数 = 得分>0的B_k数量

### 5. 最佳M选择
- 过滤: 匹配数 < 3的M值被排除
- 排序: 优先平均得分,其次匹配数,最后M值大小
- 选择: 得分最高的M值

## 配置参数 (lineConfig.json)

```json
{
  "anchorMLines": {
    "enabled": true,                      // 启用/禁用功能
    "zigzag_percent": 10,                 // 小级别ZigZag阈值(%)
    "pivot_window": 3,                    // 拐点窗口大小
    "m_range": {
      "start": 13.0,                      // M值起始(%)
      "end": 9.0,                         // M值结束(%)
      "step": -0.1                        // M值步长(%)
    },
    "max_k": 20,                          // 最大K值
    "match_tolerance_ratio": 0.006,       // 匹配容差(0.6%)
    "min_matches": 3,                     // 最小匹配数要求
    "tiebreaker_prefer_higher_M": true,   // 并列时优先更大M
    "line_style": {
      "color": "#8A2BE2",                 // 线条颜色(紫色)
      "linewidth": 1.0,                   // 线宽
      "alpha": 0.85                       // 透明度
    },
    "text_style": {
      "fontsize": 8,                      // 字号
      "x_offset": 5                       // X轴偏移
    },
    "annotate_format": "K={K} 价格={price}",  // 标注格式
    "anchor_fallback_window_days": 60     // 回退窗口(天)
  }
}
```

## 输出内容

### 1. 图表上的紫色横线
- 显示用于评分的小级别极值
- 每条横线对应一个匹配的极值价格
- 线旁标注: "K=X 价格=Y.YY"

### 2. 右上角信息框
```
M=12.2%
B: [4.12, 4.57, 5.01, 5.46, 5.91, 6.36, 6.80, 7.25, 7.70]
Score: 34.6
Matches: 8
```

### 3. JSON结果
保存在 `processing_results.json` 中:
```json
{
  "stock_code": "600235",
  "stock_name": "民丰特纸",
  "success": true,
  "anchorMLines": {
    "best_M": 12.2,
    "avg_score": 34.64,
    "matches_count": 8,
    "B_values": [4.12, 4.57, 5.01, 5.46, 5.91, 6.36, 6.80, 7.25, 7.70, 8.14],
    "anchor_low": 3.67,
    "anchor_date": "2024-02-08 00:00:00"
  }
}
```

## 使用方法

### 基本用法
```bash
# 默认处理(功能自动启用)
cd drawBaseLayerLine
python draw_lines_unified.py --date 2025-10-20
```

### 禁用M线功能
修改 `lineConfig.json`:
```json
{
  "anchorMLines": {
    "enabled": false
  }
}
```

### 调整参数
```json
{
  "anchorMLines": {
    "zigzag_percent": 5,          // 更灵敏的小级别ZigZag
    "min_matches": 5,             // 更严格的匹配要求
    "match_tolerance_ratio": 0.01 // 更宽松的容差(1%)
  }
}
```

## 技术实现

### 核心函数
1. `compute_zigzag_small()` - 计算小级别ZigZag
2. `get_local_extremes_around_turns()` - 提取拐点附近极值
3. `generate_B_series()` - 生成B序列
4. `score_M()` - M值评分
5. `select_best_M()` - 选择最佳M
6. `compute_anchor_M_lines()` - 主计算函数

### 绘图集成
- 在 `create_unified_chart()` 中集成
- 使用 `ax.axhline()` 绘制横线
- 使用 `ax.text()` 添加标注
- 线程安全,支持多线程处理

## 性能特点

- **线程安全**: 无共享可变状态
- **高效计算**: O(n)时间复杂度
- **鲁棒性强**: 
  - 数据不足时安全退出
  - 无匹配时不绘制
  - 异常捕获不中断流程

## 应用场景

### 场景1: 震荡市场
- 小级别ZigZag捕捉频繁转折
- M值评分识别主要支撑/压力位
- 紫色横线标注关键价格点

### 场景2: 趋势市场
- 较大的M值(接近13%)匹配趋势
- 较少的匹配点(3-5个)
- 清晰的上升通道

### 场景3: 数据不足
- 锚定日期后数据<10天: 跳过
- ZigZag无转折点: 跳过
- 匹配数<3: 跳过,不绘制

## 测试结果

### 600235 民丰特纸
- 锚点: 2024-02-08, 3.67元
- 最佳M: 12.2%
- 得分: 34.64
- 匹配: 8个
- B序列: [4.12, 4.57, 5.01, ...]
- ✅ 功能正常

### 000001 平安银行
- 锚点: 2024-01-23, 8.96元
- 最佳M: 12.2%
- 得分: 40.4
- 匹配: 3个
- B序列: [10.05, 11.15, 12.24, ...]
- ✅ 功能正常

## 调优建议

### 提高灵敏度
```json
{
  "zigzag_percent": 5,           // 更小阈值
  "min_matches": 2,              // 降低要求
  "match_tolerance_ratio": 0.01  // 放宽容差
}
```

### 提高准确性
```json
{
  "zigzag_percent": 15,          // 更大阈值
  "min_matches": 5,              // 提高要求
  "match_tolerance_ratio": 0.003 // 收紧容差
}
```

### 调整M值范围
```json
{
  "m_range": {
    "start": 15.0,    // 更大M值
    "end": 8.0,       // 更小M值
    "step": -0.05     // 更细步长
  }
}
```

## 注意事项

1. **计算开销**: M值遍历会增加计算时间(约+10-20%)
2. **视觉效果**: 紫色横线可能较多,注意区分
3. **数据质量**: 依赖高质量的K线数据
4. **参数调优**: 不同市场环境需要不同参数

## 未来优化方向

1. 自适应M值范围(根据市场波动率)
2. 多级别M线(不同时间周期)
3. M值趋势分析(M值随时间变化)
4. 机器学习优化参数

---

**版本**: 1.0  
**日期**: 2025-10-20  
**状态**: ✅ 已实现并测试通过
