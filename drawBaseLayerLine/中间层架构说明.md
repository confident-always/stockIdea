# ä¸­é—´å±‚ç”»çº¿æ¶æ„è¯´æ˜

## ğŸ“‹ è®¾è®¡åŸåˆ™

**æ ¸å¿ƒæ€æƒ³**: åŸºç¡€å±‚æä¾›æ•°æ®ï¼Œä¸­é—´å±‚ç»Ÿä¸€ç»˜å›¾

```
åŸºç¡€å±‚ (draw_lines_base.py)
   â†“ æä¾›æ•°æ®
   â€¢ é˜¶æ®µä½ç‚¹æ•°æ®
   â€¢ è‚¡ç¥¨ä¿¡æ¯
   â€¢ ç™¾åˆ†æ¯”é…ç½®
   â†“
ä¸­é—´å±‚ (draw_lines_mid.py)
   â†“ è®¡ç®— + ç»˜åˆ¶
   â€¢ è°ƒç”¨åŸºç¡€å±‚è·å–æ•°æ®
   â€¢ è®¡ç®—AnchorMçº¿
   â€¢ ç»Ÿä¸€ç»˜åˆ¶æ‰€æœ‰çº¿æ¡
   â†“ è¾“å‡º
   â€¢ å®Œæ•´å›¾è¡¨ (PNG)
   â€¢ AnchorMç»“æœ (JSON)
```

## ğŸ”„ æ•°æ®æµç¨‹

### 1. åŸºç¡€å±‚æä¾›çš„æ•°æ®

```python
from draw_lines_base import UnifiedLineDrawer as BaseDrawer

base_drawer = BaseDrawer()

# æä¾›çš„æ–¹æ³•:
df = base_drawer.validate_and_load_data(stock_code, data_dir)  # æ•°æ®åŠ è½½
stage_lows = base_drawer.find_stage_lows_unified(df)           # é˜¶æ®µä½ç‚¹
percent_list = base_drawer.percent_list                         # ç™¾åˆ†æ¯”é…ç½®
stock_info = base_drawer.stock_info                             # è‚¡ç¥¨ä¿¡æ¯
```

### 2. ä¸­é—´å±‚çš„å¤„ç†æµç¨‹

```python
def create_mid_chart(stock_code, stock_name, df, output_file):
    # Step 1: è·å–åŸºç¡€æ•°æ®
    stage_lows = self.base_drawer.find_stage_lows_unified(df)
    
    # Step 2: è®¡ç®—AnchorMçº¿æ•°æ®
    anchor_low, anchor_date = stage_lows[0][1], stage_lows[0][2]
    m_lines_result = self.compute_anchor_M_lines(df, anchor_low, anchor_date)
    
    # Step 3: ç»Ÿä¸€ç»˜åˆ¶å›¾è¡¨
    with matplotlib_lock:
        # å‡†å¤‡mplfinanceæ•°æ®
        df_mpf = prepare_data(df, stage_lows)
        
        # å‡†å¤‡ç»˜å›¾å…ƒç´ 
        additional_plots = []
        
        # æ·»åŠ é˜¶æ®µä½ç‚¹çº¿
        for idx, price, date in stage_lows:
            additional_plots.append(make_hline(price, 'blue'))
        
        # æ·»åŠ ç™¾åˆ†æ¯”çº¿
        for percent in self.base_drawer.percent_list:
            target_price = calculate_price(base_price, percent)
            additional_plots.append(make_hline(target_price, 'hotpink'))
        
        # åˆ›å»ºKçº¿å›¾
        fig, axes = mpf.plot(df_mpf, addplot=additional_plots, returnfig=True)
        
        # æ·»åŠ AnchorMçº¿
        if m_lines_result:
            for k, B_k in zip(K_values, B_values):
                ax.axhline(B_k, color='purple')
                ax.text(-0.02, B_k, f'K={k} ä»·æ ¼={B_k:.2f}')
        
        # ä¿å­˜å›¾è¡¨
        plt.savefig(output_file)
    
    return True, m_lines_result
```

## ğŸ¨ ç»˜åˆ¶çš„çº¿æ¡

### åŸºç¡€çº¿æ¡ï¼ˆæ¥è‡ªåŸºç¡€å±‚é…ç½®ï¼‰

1. **Kçº¿å›¾** - mplfinanceç»˜åˆ¶ï¼Œçº¢æ¶¨ç»¿è·Œ
2. **é˜¶æ®µä½ç‚¹çº¿** - è“è‰²æ°´å¹³çº¿
3. **ç™¾åˆ†æ¯”æ¶¨å¹…çº¿** - ç²‰è‰²è™šçº¿ï¼Œä»`lineConfig.json`è¯»å–

### AnchorMçº¿æ¡ï¼ˆä¸­é—´å±‚è®¡ç®—ï¼‰

1. **ç´«è‰²æ¨ªçº¿** - æ¯ä¸ªKå€¼å¯¹åº”ä¸€æ¡çº¿ï¼ˆB_kä»·æ ¼ï¼‰
2. **Kå€¼æ ‡æ³¨** - å·¦ä¾§æ˜¾ç¤º"K=X ä»·æ ¼=Y.YY"
3. **Må€¼ä¿¡æ¯æ¡†** - å·¦ä¸Šè§’æ˜¾ç¤ºMå€¼ã€Scoreã€Matches

## âš™ï¸ å…³é”®é…ç½®

### lineConfig.json

```json
{
  "percent_dic": ["3%", "16%", "25%", ...],  // ç™¾åˆ†æ¯”çº¿é…ç½®
  "zigzag_period": 49,                        // é˜¶æ®µä½ç‚¹ZigZagé˜ˆå€¼
  "anchorMLines": {
    "enabled": true,                          // æ˜¯å¦å¯ç”¨AnchorMçº¿
    "zigzag_percent": 10,                     // Mçº¿è¯„åˆ†ZigZagé˜ˆå€¼
    "pivot_window": 3,                        // å±€éƒ¨æå€¼çª—å£
    "m_range": {
      "start": 13.0,                          // Må€¼èµ·å§‹
      "end": 9.0,                             // Må€¼ç»“æŸ
      "step": -0.1                            // Må€¼æ­¥é•¿
    },
    "max_k": 20,                              // æœ€å¤§Kå€¼
    "line_style": {
      "color": "#8A2BE2",                     // ç´«è‰²
      "linewidth": 3.0,                       // çº¿å®½
      "alpha": 0.9                            // é€æ˜åº¦
    }
  }
}
```

## ğŸ“Š è¾“å‡ºç»“æœ

### å›¾è¡¨æ–‡ä»¶

```
20251020-drawLineMid/
â”œâ”€â”€ ADX243_601608_ä¸­ä¿¡é‡å·¥.png
â”œâ”€â”€ ADX243_600801_åæ–°æ°´æ³¥.png
â””â”€â”€ ...
```

æ¯å¼ å›¾åŒ…å«:
- Kçº¿å›¾ï¼ˆçº¢æ¶¨ç»¿è·Œï¼‰
- é˜¶æ®µä½ç‚¹çº¿ï¼ˆè“è‰²ï¼‰
- ç™¾åˆ†æ¯”æ¶¨å¹…çº¿ï¼ˆç²‰è‰²è™šçº¿ï¼‰
- AnchorMçº¿ï¼ˆç´«è‰²ï¼‰
- Kå€¼æ ‡æ³¨ï¼ˆå·¦ä¾§ï¼‰
- Må€¼ä¿¡æ¯æ¡†ï¼ˆå·¦ä¸Šè§’ï¼‰

### JSONç»“æœ

```json
{
  "stock_code": "601608",
  "stock_name": "ä¸­ä¿¡é‡å·¥",
  "success": true,
  "anchorMLines": {
    "best_M": 12.7,
    "avg_score": 85.3,
    "matches_count": 15,
    "B_values": [3.95, 4.40, 4.85, ...],
    "anchor_low": 3.50,
    "anchor_date": "2018-10-19"
  }
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

```bash
cd drawBaseLayerLine
python draw_lines_mid.py --date 2025-10-20 --workers 4
```

## ğŸ“ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
ğŸ¨ [601608] å¼€å§‹åˆ›å»ºä¸­é—´å±‚å›¾è¡¨
ğŸ” [601608] æ£€æµ‹é˜¶æ®µä½ç‚¹...
âœ… [601608] é˜¶æ®µä½ç‚¹: (123, 3.50, '2018-10-19')
ğŸ” [601608] è®¡ç®—AnchorMçº¿...
âœ… [601608] AnchorM: M=12.7%, åŒ¹é…æ•°=15
ğŸ¨ [601608] ç»˜åˆ¶å®Œæ•´å›¾è¡¨...
âœ… [601608] å›¾è¡¨ç”ŸæˆæˆåŠŸ (587234 bytes)
```

## âœ¨ æ¶æ„ä¼˜åŠ¿

### 1. æ¸…æ™°çš„èŒè´£åˆ†ç¦»

- **åŸºç¡€å±‚**: ä¸“æ³¨äºæ•°æ®è·å–å’Œå¤„ç†
- **ä¸­é—´å±‚**: ä¸“æ³¨äºç»˜å›¾å’Œå±•ç¤º

### 2. ä»£ç å¤ç”¨

- ä¸­é—´å±‚å¤ç”¨åŸºç¡€å±‚çš„æ‰€æœ‰æ•°æ®å¤„ç†é€»è¾‘
- é¿å…é‡å¤å®ç°ç›¸åŒåŠŸèƒ½

### 3. é«˜æ•ˆæ‰§è¡Œ

- åªç»˜åˆ¶ä¸€æ¬¡å›¾è¡¨
- æ‰€æœ‰çº¿æ¡åœ¨åŒä¸€æ¬¡mplfinanceè°ƒç”¨ä¸­å®Œæˆ
- é¿å…é‡å¤çš„æ–‡ä»¶I/O

### 4. æ˜“äºæ‰©å±•

- æ·»åŠ æ–°çº¿æ¡: åªéœ€åœ¨ä¸­é—´å±‚æ·»åŠ ç»˜å›¾ä»£ç 
- ä¿®æ”¹æ•°æ®é€»è¾‘: åªéœ€ä¿®æ”¹åŸºç¡€å±‚
- ä¸¤è€…äº’ä¸å½±å“

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### çº¿ç¨‹å®‰å…¨

```python
with matplotlib_lock:
    # æ‰€æœ‰matplotlibæ“ä½œåœ¨é”å†…æ‰§è¡Œ
    fig, axes = mpf.plot(...)
    ax.axhline(...)
    plt.savefig(...)
```

### æ—¥æœŸç±»å‹å¤„ç†

```python
# åŸºç¡€å±‚è¿”å›å­—ç¬¦ä¸²æ—¥æœŸ
stage_lows = [(idx, price, "2018-10-19")]

# ä¸­é—´å±‚è½¬æ¢ä¸ºTimestamp
anchor_date = pd.to_datetime(anchor_date)  # è‡ªåŠ¨å¤„ç†
```

### Yè½´èŒƒå›´è°ƒæ•´

```python
# ç¡®ä¿æ‰€æœ‰çº¿æ¡éƒ½åœ¨å¯è§èŒƒå›´å†…
highest_price = max(
    max_price,                    # Kçº¿æœ€é«˜ä»·
    highest_percent_price,        # æœ€é«˜ç™¾åˆ†æ¯”çº¿
    max(B_values) if B_values else 0  # æœ€é«˜AnchorMçº¿
)
ax.set_ylim(min_price - margin, highest_price + margin)
```

## ğŸ¯ ä¸åŸºç¡€å±‚çš„åŒºåˆ«

| ç‰¹æ€§ | åŸºç¡€å±‚ | ä¸­é—´å±‚ |
|------|--------|--------|
| åŠŸèƒ½ | Kçº¿ + ä½ç‚¹çº¿ + ç™¾åˆ†æ¯”çº¿ | + AnchorMçº¿ |
| è¾“å‡ºç›®å½• | `{date}-drawLineRes/` | `{date}-drawLineMid/` |
| æ˜¯å¦è®¡ç®—Må€¼ | âŒ | âœ… |
| JSONè¾“å‡º | åŸºæœ¬ä¿¡æ¯ | + AnchorMç»“æœ |
| å¤æ‚åº¦ | ä½ | ä¸­ç­‰ |
| æ‰§è¡Œé€Ÿåº¦ | å¿« | ç¨æ…¢ï¼ˆéœ€è®¡ç®—Må€¼ï¼‰ |

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å¼€å‘è°ƒè¯•**: å…ˆç”¨åŸºç¡€å±‚éªŒè¯æ•°æ®æ­£ç¡®æ€§
2. **ç”Ÿäº§ç¯å¢ƒ**: ä½¿ç”¨ä¸­é—´å±‚ç”Ÿæˆå®Œæ•´åˆ†æå›¾è¡¨
3. **æ€§èƒ½ä¼˜åŒ–**: å¯é€šè¿‡`lineConfig.json`ç¦ç”¨AnchorMçº¿
4. **è‡ªå®šä¹‰**: åœ¨ä¸­é—´å±‚æ·»åŠ æ–°çš„åˆ†æçº¿æ¡

## ğŸ‰ æ€»ç»“

âœ… **æ•°æ®ä¸ç»˜å›¾åˆ†ç¦»** - åŸºç¡€å±‚æä¾›æ•°æ®ï¼Œä¸­é—´å±‚ç»˜å›¾  
âœ… **ç»Ÿä¸€ç»˜åˆ¶** - æ‰€æœ‰çº¿æ¡åœ¨ä¸€æ¬¡è°ƒç”¨ä¸­å®Œæˆ  
âœ… **é«˜æ•ˆæ‰§è¡Œ** - é¿å…é‡å¤ç”Ÿæˆå›¾è¡¨  
âœ… **æ˜“äºæ‰©å±•** - æ¸…æ™°çš„æ¶æ„ä¾¿äºæ·»åŠ æ–°åŠŸèƒ½  
âœ… **æ—¥å¿—å®Œå–„** - æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ¸…æ™°çš„æ—¥å¿—è¾“å‡º

